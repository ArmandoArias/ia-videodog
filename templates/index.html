<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Procesador de Videos de YouTube</title>
    <!-- Usando el tema "Cosmo" de Bootswatch -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/cosmo/bootstrap.min.css">
    <!-- Font Awesome para los íconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <a class="navbar-brand" href="#">IA YouTube</a>
    </nav>

    <div class="container mt-5">
        <div class="card">
            <div class="card-header text-center">
                <h2>Procesador de Videos de YouTube</h2>
            </div>
            <div class="card-body">
                <form id="video-form">
                    <div class="form-group">
                        <label for="url_video">Ingresa la URL del video de YouTube:</label>
                        <input type="text" class="form-control" id="url_video" name="url_video" required placeholder="https://www.youtube.com/watch?v=VIDEO_ID">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Procesar Video</button>
                </form>
                <div id="progress" class="mt-4" style="display:none;">
                    <h5>Progreso:</h5>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div id="progress-messages" class="mt-3"></div>
                </div>
                <div id="resultados" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Agrega jQuery y Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <!-- Agrega el script de Socket.IO -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <!-- Bootstrap JS y Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <!-- Opcional: Bootstrap JS -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
        $(document).ready(function() {
            var socket = io();
            var sessionId = null;

            socket.on('connect', function() {
                sessionId = socket.id;
                console.log('Conectado al servidor con session ID:', sessionId);
            });

            socket.on('progreso', function(msg) {
                $('#progress-messages').append('<div>' + msg.data + '</div>');
                updateProgressBar(msg.step, msg.total_steps);
            });

            socket.on('progreso_transcripcion', function(msg) {
                $('#progress-messages').append('<div>' + msg.data + '</div>');
            });

            socket.on('resultado', function(msg) {
                $('#progress-messages').append('<div class="text-success">Procesamiento completado.</div>');
                $('#resultados').html('<h3>Sugerencias Generadas:</h3>');
                try {
                    const sugerencias = JSON.parse(msg.sugerencias);
                    for (const [key, value] of Object.entries(sugerencias)) {
                        $('#resultados').append(`
                            <div class="card mt-3">
                                <div class="card-body">
                                    <h5 class="card-title">${key}</h5>
                                    <p class="card-text">${value}</p>
                                    <button class="btn btn-primary btn-sm copy-btn" data-text="${value}">
                                        <i class="fa fa-copy"></i> Copiar
                                    </button>
                                </div>
                            </div>
                        `);
                    }
                } catch (e) {
                    $('#progress-messages').append(`<div class="text-danger">Error al parsear las sugerencias: ${e.message}</div>`);
                }
                enableSubmitButton();
            });

            // Evento para copiar el texto al portapapeles
            $(document).on('click', '.copy-btn', function() {
                var textToCopy = $(this).attr('data-text');
                navigator.clipboard.writeText(textToCopy).then(function() {
                    // Opcional: mostrar un mensaje de éxito
                    alert('Texto copiado al portapapeles.');
                }, function(err) {
                    alert('Error al copiar el texto: ' + err);
                });
            });

            socket.on('error', function(msg) {
                $('#progress-messages').append('<div class="text-danger">Error: ' + msg.data + '</div>');
                enableSubmitButton();
            });

            function updateProgressBar(currentStep, totalSteps) {
                var progressPercentage = (currentStep / totalSteps) * 100;
                $('#progress-bar').css('width', progressPercentage + '%');
                $('#progress-bar').attr('aria-valuenow', progressPercentage);
            }

            function enableSubmitButton() {
                $('#video-form button[type="submit"]').prop('disabled', false);
            }

            $('#video-form').on('submit', function(e) {
                e.preventDefault();
                let url_video = $('#url_video').val();

                // Validar y limpiar la URL de YouTube
                function limpiarYoutubeURL(url) {
                    const regex = /^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:watch\?(?:.*&)?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:\S+)?$/;
                    const match = url.match(regex);
                    if (match && match[1]) {
                        return `https://www.youtube.com/watch?v=${match[1]}`;
                    } else {
                        return null;
                    }
                }

                const urlLimpia = limpiarYoutubeURL(url_video);
                if (!urlLimpia) {
                    alert('Por favor, ingresa una URL válida de YouTube.');
                    return;
                }

                // Resetear el progreso
                $('#progress-bar').css('width', '0%');
                $('#progress-messages').html('');
                $('#resultados').html('');
                $('#video-form button[type="submit"]').prop('disabled', true);

                // Mostrar el progreso
                $('#progress').show();
                $('#progress-messages').append('<div>Iniciando el procesamiento...</div>');

                fetch('/procesar_video', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ url_video: urlLimpia, session_id: sessionId }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        $('#progress-messages').append(`<div class="text-danger">Error: ${data.error}</div>`);
                        enableSubmitButton();
                    } else {
                        $('#progress-messages').append('<div>Procesamiento iniciado...</div>');
                    }
                })
                .catch(error => {
                    $('#progress-messages').append(`<div class="text-danger">Error: ${error}</div>`);
                    enableSubmitButton();
                });
            });
        });
    </script>
</body>
</html>
